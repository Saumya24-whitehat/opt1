(function(c,d){"object"==typeof exports&&"undefined"!=typeof module?d(exports):"function"==typeof define&&define.amd?define(["exports"],d):(c="undefined"==typeof globalThis?c||self:globalThis,d(c.Datafeeds={}))})(this,function(s){"use strict";function t(l,a,b){var c=a.toLowerCase(),d=c.split(b),e=l.split(b),f=d.indexOf("mm"),g=d.indexOf("dd"),h=d.indexOf("yyyy"),i=parseInt(e[h]);100>i&&(i+=2e3);var m=parseInt(e[f]);return 10>m&&(m="0"+m),i+"-"+m+"-"+e[g]}function H(b){var i,b=b.toString(),j=b.substring(0,2),d=b.substring(2,5),e=b.substring(5,7);"JAN"==d?i=1:"FEB"==d?i=2:"MAR"==d?i=3:"APR"==d?i=4:"MAY"==d?i=5:"JUN"==d?i=6:"JUL"==d?i=7:"AUG"==d?i=8:"SEP"==d?i=9:"OCT"==d?i=10:"NOV"==d?i=11:"DEC"==d&&(i=12);var f=j+"/"+i+"/"+e,g=t(f,"dd/MM/yyyy","/");return g}function a(c){var d=[];return $.ajax({url:"/opt/hcharts/stx8req/php/getMinDate_FNO_TV_v2.php",type:"POST",cache:!1,async:!1,data:{symbol:c},success:function(b){d.push(b)}}),d[0]}function u(){}function e(b){return void 0===b?"":"string"==typeof b?b:b.message}function f(d,a){let b=0;return b="D"===d||"1D"===d?a:"M"===d||"1M"===d?31*a:"W"===d||"1W"===d?7*a:a*parseInt(d)/1440,60*(60*(24*b))}function v(f,a,b,c){const d=f[a];return Array.isArray(d)&&(!c||Array.isArray(d[0]))?d[b]:d}function h(d,a,b){return d+(void 0===a?"":"_%|#|%_"+a)+(void 0===b?"":"_%|#|%_"+b)}function i(c,a){return void 0===c?a:c}function g(){var f,g,h,i,j=new Date().toISOString().slice(0,10);return j>default_expiry_date?"XX"==default_option_type?(f="Futures_Latest",g="Options_Latest",h="",i="Options_Hist"):(f="Futures_Latest",g="Options_Latest",h="Futures_Hist",i=""):"XX"==default_option_type?(f="",g="Options_Latest",h="Futures_Hist",i="Options_Hist"):(f="Futures_Latest",g="",h="Futures_Hist",i="Options_Hist"),{supports_search:!0,supports_group_request:!1,supported_resolutions:["1","2","3","4","5","10","15","20","30","60","120","240","1D","1W","1M","75"],supports_marks:!1,supports_timescale_marks:!1,exchanges:[{value:"NSE",name:"NSE",desc:"NSE"}],symbols_types:[{name:"Futures (Latest)",value:f},{name:"Options (Latest)",value:g},{name:"Futures (Historical)",value:h},{name:"Options (Historical)",value:i}]}}class j{constructor(c,a){this._datafeedUrl=c,this._requester=a}getBars(c,d,b,f){let{from:g,to:h,firstDataRequest:i}=b;var j=c.name,k=c.description,l=k.split(" "),m=l[1],n=m.trim(),o=new Date(n),p=m.substring(0,7),q=n.substring(0,2),r=n.substring(2,5),s=n.substring(5,7),t=H(s+r+q),u=new Date(t),v=new Date,w=u.getDate()-95,x=new Date().toISOString().slice(0,10),y=new Date(t).toISOString().slice(0,10),z=0;if(y>=x&&(z=1),0==z){var I=a(j);if(null==f||"undefined"==f)var J=2,K=new Date(1e3*b.from).toISOString().slice(0,10),L=new Date(1e3*b.to).toISOString().slice(0,10);else{var J=2;if(""!=I)var K=I,L=new Date(1e3*b.to).toISOString().slice(0,10);else var K=new Date(1e3*b.from).toISOString().slice(0,10),L=new Date(1e3*b.to).toISOString().slice(0,10)}}else{var I=a(j);if(null==f||"undefined"==f)var J=1,K=new Date(1e3*b.from).toISOString().slice(0,10),L=new Date(1e3*b.to).toISOString().slice(0,10);else var J=0,M=Date.parse(I)/1e3,K=I,L=new Date(1e3*b.to).toISOString().slice(0,10)}const F={symbol:c.ticker||"",resolution:d,from:K,to:L,u:userName,sid:sid,DataRequest:J,firstDataRequest:i};return void 0!==b.countBack&&(F.countback=b.countBack),void 0!==c.currency_code&&(F.currencyCode=c.currency_code),void 0!==c.unit_id&&(F.unitId=c.unit_id),new Promise((g,d)=>{this._requester.sendRequest(this._datafeedUrl,"opt/getdataFNO_Chart_TV_Charts_Daily_v2.php",F).then(h=>{if("ok"!==h.s&&"no_data"!==h.s)return void f([],{noData:!0});const b=[],a={noData:!1};if("no_data"===h.s)a.noData=!0,a.nextTime=h.nextTime;else{const c=void 0!==h.v,a=void 0!==h.o;for(let d=0;d<h.t.length;++d){const e={time:1e3*h.t[d],close:parseFloat(h.c[d]),open:parseFloat(h.c[d]),high:parseFloat(h.c[d]),low:parseFloat(h.c[d])};a&&(e.open=parseFloat(h.o[d]),e.high=parseFloat(h.h[d]),e.low=parseFloat(h.l[d])),c&&(e.volume=parseFloat(h.v[d])),b.push(e)}}g({bars:b,meta:a})}).catch(b=>{const a=e(b);console.warn(`HistoryProvider: getBars() failed, error=${a}`),d(a)})})}}class k{constructor(c,a){this._subscribers={},this._requestsPending=0,this._historyProvider=c,setInterval(this._updateData.bind(this),a)}subscribeBars(e,a,b,c){this._subscribers.hasOwnProperty(c)||(this._subscribers[c]={lastBarTime:null,listener:b,resolution:a,symbolInfo:e},u(`DataPulseProvider: subscribed for #${c} - {${e.name}, ${a}}`))}unsubscribeBars(b){delete this._subscribers[b]}_updateData(){if(!(0<this._requestsPending))for(const c in this._requestsPending=0,this._subscribers)this._requestsPending+=1,this._updateDataForSubscriber(c).then(()=>{this._requestsPending-=1,u(`DataPulseProvider: data for #${c} updated successfully, pending=${this._requestsPending}`)}).catch(a=>{this._requestsPending-=1,u(`DataPulseProvider: data for #${c} updated with error=${e(a)}, pending=${this._requestsPending}`)})}_updateDataForSubscriber(e){const a=this._subscribers[e],b=parseInt((Date.now()/1e3).toString()),c=b-f(a.resolution,10);return this._historyProvider.getBars(a.symbolInfo,a.resolution,{from:c,to:b,countBack:50,firstDataRequest:!1}).then(a=>{this._onSubscriberDataReceived(e,a)})}_onSubscriberDataReceived(f,a){if(this._subscribers.hasOwnProperty(f)){const b=a.bars;if(0!==b.length){const c=b[b.length-1],d=this._subscribers[f];if(!(null!==d.lastBarTime&&c.time<d.lastBarTime)){const e=null!==d.lastBarTime&&c.time>d.lastBarTime;if(e){if(2>b.length)throw new Error("Not enough bars in history for proper pulse update. Need at least 2.");const c=b[b.length-2];d.listener(c)}d.lastBarTime=c.time,d.listener(c)}}}}}class l{constructor(b){this._subscribers={},this._requestsPending=0,this._quotesProvider=b,setInterval(this._updateQuotes.bind(this,1),3e4)}subscribeQuotes(e,a,b,c){this._subscribers[c]={symbols:e,fastSymbols:a,listener:b}}unsubscribeQuotes(b){delete this._subscribers[b]}_updateQuotes(f){if(!(0<this._requestsPending))for(const a in this._subscribers){this._requestsPending++;const b=this._subscribers[a];this._quotesProvider.getQuotes(1===f?b.fastSymbols:b.symbols).then(c=>{this._requestsPending--,this._subscribers.hasOwnProperty(a)&&(b.listener(c),u(`QuotesPulseProvider: data for #${a} (${f}) updated successfully, pending=${this._requestsPending}`))}).catch(b=>{this._requestsPending--,u(`QuotesPulseProvider: data for #${a} (${f}) updated with error=${e(b)}, pending=${this._requestsPending}`)})}}}class b{constructor(d,a,b){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=d,this._datafeedSupportedResolutions=a,this._requester=b,this._readyPromise=this._init(),this._readyPromise.catch(b=>{console.error(`SymbolsStorage: Cannot init, error=${b.toString()}`)})}resolveSymbol(e,a,b){return this._readyPromise.then(()=>{const c=this._symbolsInfo[h(e,a,b)];return void 0===c?Promise.reject("invalid symbol"):Promise.resolve(c)})}searchSymbols(j,k,b,c){return this._readyPromise.then(()=>{const d=[],a=0===j.length;j=j.toUpperCase();for(const c of this._symbolsList){const e=this._symbolsInfo[c];if(void 0===e)continue;if(0<b.length&&e.type!==b)continue;if(k&&0<k.length&&e.exchange!==k)continue;const f=e.name.toUpperCase().indexOf(j),g=e.description.toUpperCase().indexOf(j);if(a||0<=f||0<=g){const b=d.some(b=>b.symbolInfo===e);if(!b){const b=0<=f?f:8e3+g;d.push({symbolInfo:e,weight:b})}}}const e=d.sort((c,a)=>c.weight-a.weight).slice(0,c).map(c=>{const a=c.symbolInfo;return{symbol:a.name,full_name:a.full_name,description:a.description,exchange:a.exchange,params:[],type:a.type,ticker:a.name}});return Promise.resolve(e)})}_init(){const d=[],a={};for(const b of this._exchangesList)a[b]||(a[b]=!0,d.push(this._requestExchangeData(b)));return Promise.all(d).then(()=>{this._symbolsList.sort()})}_requestExchangeData(f){return new Promise((a,b)=>{this._requester.sendRequest(this._datafeedUrl,"opt/Symbols_FNO_TV_Charts_v23_Hiekin_v2.php",{group:f}).then(c=>{try{this._onExchangeDataReceived(f,c)}catch(c){return void b(c)}a()}).catch(b=>{u(`SymbolsStorage: Request data for exchange '${f}' failed, reason=${e(b)}`),a()})})}_onExchangeDataReceived(e,j){let b=0;try{for(const c=j.symbol.length,o=void 0!==j.ticker;b<c;++b){const c=j.symbol[b],a=v(j,"exchange-listed",b),d=v(j,"exchange-traded",b),e=d+":"+c,f=v(j,"currency-code",b),g=v(j,"unit-id",b),k=o?v(j,"ticker",b):c,l={ticker:k,name:c,base_name:[a+":"+c],full_name:e,listed_exchange:a,exchange:d,currency_code:f,original_currency_code:v(j,"original-currency-code",b),unit_id:g,original_unit_id:v(j,"original-unit-id",b),unit_conversion_types:v(j,"unit-conversion-types",b,!0),description:v(j,"description",b),has_intraday:i(v(j,"has-intraday",b),!1),has_no_volume:i(v(j,"has-no-volume",b),!1),minmov:v(j,"minmovement",b)||v(j,"minmov",b)||0,minmove2:v(j,"minmove2",b)||v(j,"minmov2",b),fractional:v(j,"fractional",b),pricescale:v(j,"pricescale",b),type:v(j,"type",b),session:v(j,"session-regular",b),timezone:v(j,"timezone",b),supported_resolutions:i(v(j,"supported-resolutions",b,!0),this._datafeedSupportedResolutions),has_daily:i(v(j,"has-daily",b),!0),intraday_multipliers:i(v(j,"intraday-multipliers",b,!0),["1","5","15","30","60"]),has_weekly_and_monthly:v(j,"has-weekly-and-monthly",b),has_empty_bars:v(j,"has-empty-bars",b),volume_precision:i(v(j,"volume-precision",b),0),format:"price"};this._symbolsInfo[k]=l,this._symbolsInfo[c]=l,this._symbolsInfo[e]=l,(void 0!==f||void 0!==g)&&(this._symbolsInfo[h(k,f,g)]=l,this._symbolsInfo[h(c,f,g)]=l,this._symbolsInfo[h(e,f,g)]=l),this._symbolsList.push(c)}}catch(a){throw new Error(`SymbolsStorage: API error when processing exchange ${e} symbol #${b} (${j.symbol[b]}): ${a.message}`)}}}class c{constructor(e,a,b,c=6e4){this._configuration=g(),this._symbolsStorage=null,this._datafeedURL=e,this._requester=b,this._historyProvider=new j(e,this._requester),this._quotesProvider=a,this._dataPulseProvider=new k(this._historyProvider,c),this._quotesPulseProvider=new l(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then(b=>{null===b&&(b=g()),this._setupWithConfiguration(b)})}onReady(b){this._configurationReadyPromise.then(()=>{b(this._configuration)})}getQuotes(d,a,b){this._quotesProvider.getQuotes(d).then(a).catch(b)}subscribeQuotes(e,a,b,c){this._quotesPulseProvider.subscribeQuotes(e,a,b,c)}unsubscribeQuotes(b){this._quotesPulseProvider.unsubscribeQuotes(b)}getServerTime(d){this._configuration.supports_time&&this._send("opt/time_TV.php").then(a=>{const b=parseInt(a);isNaN(b)||d(b)}).catch(b=>{u(`UdfCompatibleDatafeed: Fail to load server time, error=${e(b)}`)})}searchSymbols(f,a,b,c){var d,i=new Date().toISOString().slice(0,10);if(d=i>default_expiry_date?"XX"==default_option_type?"Futures_Hist":"Options_Hist":"XX"==default_option_type?"Futures_Latest":"Options_Latest",this._configuration.supports_search){const g={limit:30,query:f.toUpperCase(),type:b,exchange:a,default_symbol_type_val:d};this._send("opt/Search_FNO_TV_optimized_v2.php",g).then(b=>void 0===b.s?void c(b):(u(`UdfCompatibleDatafeed: search symbols error=${b.errmsg}`),void c([]))).catch(a=>{u(`UdfCompatibleDatafeed: Search symbols for '${f}' failed. Error=${e(a)}`),c([])})}else{if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(f,a,b,30).then(c).catch(c.bind(null,[]))}}resolveSymbol(f,j,b,a){function c(b){j(b)}const d=a&&a.currencyCode,g=a&&a.unitId;if(!this._configuration.supports_group_request){const a={symbol:f};void 0!==d&&(a.currencyCode=d),void 0!==g&&(a.unitId=g),this._send("opt/Symbols_FNO_TV_Charts_v23_Hiekin_v2.php",a).then(d=>{void 0===d.s?c(d):b("unknown_symbol")}).catch(c=>{u(`UdfCompatibleDatafeed: Error resolving symbol: ${e(c)}`),b("unknown_symbol")})}else{if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.resolveSymbol(f,d,g).then(c).catch(b)}}getBars(g,a,b,c,d,e){this._historyProvider.getBars(g,a,b,d).then(b=>{c(b.bars,b.meta)}).catch(e)}subscribeBars(e,a,b,c){this._dataPulseProvider.subscribeBars(e,a,b,c)}unsubscribeBars(b){this._dataPulseProvider.unsubscribeBars(b)}_requestConfiguration(){return this._send("opt/configTV.php").catch(b=>(u(`UdfCompatibleDatafeed: Cannot get datafeed configuration - use default, error=${e(b)}`),null))}_send(c,a){return this._requester.sendRequest(this._datafeedURL,c,a)}_setupWithConfiguration(c){if(this._configuration=c,void 0===c.exchanges&&(c.exchanges=[]),!c.supports_search&&!c.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");(c.supports_group_request||!c.supports_search)&&(this._symbolsStorage=new b(this._datafeedURL,c.supported_resolutions||[],this._requester)),u(`UdfCompatibleDatafeed: Initialized with ${JSON.stringify(c)}`)}}class m{constructor(c,a){this._datafeedUrl=c,this._requester=a}getQuotes(d){return new Promise((f,g)=>{this._requester.sendRequest(this._datafeedUrl,"opt/WatchList_TV_Charts_v1.php",{symbols:d}).then(b=>{"ok"===b.s?f(b.d):g(b.errmsg)}).catch(c=>{const a=e(c);g(`network error: ${a}`)})})}}class n{constructor(b){b&&(this._headers=b)}sendRequest(e,f,g){if(void 0!==g){const b=Object.keys(g);0!==b.length&&(f+="?"),f+=b.map(b=>`${encodeURIComponent(b)}=${encodeURIComponent(g[b])}`).join("&")}const a={credentials:"same-origin"};return void 0!==this._headers&&(a.headers=this._headers),fetch(`${e}/${f}`,a).then(b=>b.text()).then(b=>JSON.parse(b))}}s.UDFCompatibleDatafeed=class extends c{constructor(e,a=3e4){const b=new n,c=new m(e,b);super(e,c,b,a)}},Object.defineProperty(s,"__esModule",{value:!0})});